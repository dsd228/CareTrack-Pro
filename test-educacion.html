<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Test Educación - CareTrack-Pro</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="main-content"></div>
  
  <script type="module">
    // Mock dependencies
    window.showToast = function(message, type = "success") {
      console.log('Toast:', message, type);
      alert(message);
    };

    // Mock API functions
    window.buscarMedicamento = async function(term) {
      return {
        brand_name: [`Mock Medicine for ${term}`],
        generic_name: [`Generic ${term}`],
        description: [`Mock description for ${term}`],
        purpose: [`Mock purpose for ${term}`],
        dosage_and_administration: [`Mock dosage for ${term}`],
        contraindications: [`Mock contraindications for ${term}`],
        active_ingredient: [`Mock active ingredient for ${term}`],
        adverse_reactions: [`Mock side effects for ${term}`]
      };
    };

    window.buscarWiki = async function(term, lang="es") {
      return {
        title: `Mock Wikipedia: ${term}`,
        extract: `This is mock Wikipedia content for ${term}.`
      };
    };

    // Mock Firebase functions
    const collection = (db, name) => ({ name });
    const getDocs = async (collection) => ({ docs: [] });
    const doc = (db, collection, id) => ({ collection, id });
    const getDoc = async (docRef) => ({ exists: () => false, data: () => ({}) });
    const setDoc = async (docRef, data) => console.log('Mock setDoc:', docRef, data);
    const deleteDoc = async (docRef) => console.log('Mock deleteDoc:', docRef);
    const addDoc = async (collection, data) => console.log('Mock addDoc:', collection, data);

    // Education module implementation
    function renderEducacion(container) {
      container.innerHTML = `
        <div class="panel-educacion">
          <div class="panel-header">
            <h2>Panel de Educación</h2>
            <div class="panel-actions">
              <button id="educacion_agregar" class="btn-primary">Agregar</button>
              <button id="educacion_youtube" class="btn-secondary" style="display:none;">YouTube</button>
            </div>
          </div>
          
          <div class="panel-search">
            <div class="search-group">
              <input type="text" id="educacion_busqueda" placeholder="Buscar información médica..." class="search-input">
              <button id="educacion_buscar" class="btn-search">Buscar</button>
            </div>
          </div>

          <div class="panel-tabs">
            <button class="tab-btn active" data-tab="enfermedades">Enfermedades</button>
            <button class="tab-btn" data-tab="medicamentos">Medicamentos</button>
            <button class="tab-btn" data-tab="protocolos">Protocolos</button>
            <button class="tab-btn" data-tab="videos">Videos</button>
          </div>

          <div class="panel-notes">
            <h3>Notas personales</h3>
            <textarea id="educacion_texto" placeholder="Escriba sus notas educativas aquí..." rows="4"></textarea>
            <div class="notes-actions">
              <button id="educacion_guardar" class="btn-save">Guardar notas</button>
              <button id="educacion_cargar" class="btn-load">Cargar notas</button>
            </div>
          </div>

          <div id="educacion-content" class="panel-content">
            <p>Cargando contenido...</p>
          </div>
        </div>

        <!-- Modal para detalles/edición -->
        <div id="edu-modal" class="modal" style="display:none;">
          <div class="modal-content">
            <span id="edu-modal-close" class="modal-close">&times;</span>
            <div id="edu-modal-content"></div>
          </div>
        </div>

        <!-- Modal para YouTube -->
        <div id="youtube-modal" class="modal" style="display:none;">
          <div class="modal-content">
            <span id="youtube-modal-close" class="modal-close">&times;</span>
            <div id="youtube-modal-content"></div>
          </div>
        </div>
      `;
      
      // Initialize functionality
      setTimeout(() => panelEducacionInit(), 100);
    }

    function panelEducacionInit() {
      console.log('Initializing education panel...');
      
      const busqueda = document.getElementById('educacion_busqueda');
      const buscarBtn = document.getElementById('educacion_buscar');
      const content = document.getElementById('educacion-content');
      const agregarBtn = document.getElementById('educacion_agregar');
      const youtubeBtn = document.getElementById('educacion_youtube');
      const text = document.getElementById('educacion_texto');
      const tabs = document.querySelectorAll('.tab-btn');
      const modal = document.getElementById('edu-modal');
      const modalContent = document.getElementById('edu-modal-content');
      const modalCloseBtn = document.getElementById('edu-modal-close');
      const ytModal = document.getElementById('youtube-modal');
      const ytModalContent = document.getElementById('youtube-modal-content');
      const ytModalCloseBtn = document.getElementById('youtube-modal-close');
      let activeTab = "enfermedades";

      // Tab functionality
      tabs.forEach(tab => {
        tab.addEventListener('click', async () => {
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          activeTab = tab.dataset.tab;
          agregarBtn.style.display = 'inline-block';
          youtubeBtn.style.display = (activeTab === 'videos') ? 'inline-block' : 'none';
          await loadTabData(activeTab);
        });
      });

      // Search functionality  
      buscarBtn.onclick = async () => {
        const term = busqueda.value.trim().toLowerCase();
        if(!term){
          content.innerHTML = "<span style='color:#D23'>Ingresa un término a buscar.</span>";
          return;
        }
        await searchTerm(term);
      };

      // Save/Load notes
      document.getElementById('educacion_guardar').onclick = async () => {
        console.log('Saving notes:', text.value);
        showToast('Notas guardadas');
      };

      document.getElementById('educacion_cargar').onclick = async () => {
        text.value = "Notas cargadas de ejemplo";
        showToast('Notas cargadas');
      };

      // Add new item
      agregarBtn.onclick = () => {
        showFormModal(activeTab, null);
      };

      // Modal close
      modalCloseBtn.onclick = () => {
        modal.style.display = 'none';
        modalContent.innerHTML = '';
      };

      ytModalCloseBtn.onclick = () => {
        ytModal.style.display = 'none';
        ytModalContent.innerHTML = '';
      };

      // YouTube functionality
      youtubeBtn.onclick = () => {
        showYouTubeModal();
      };

      // Load initial content
      loadTabData(activeTab);

      async function searchTerm(term) {
        content.innerHTML = '<p>Buscando...</p>';
        
        let items = [];
        
        // Mock external API search
        if(activeTab === 'medicamentos') {
          const fdaData = await window.buscarMedicamento(term);
          if(fdaData) {
            items.push({
              nombre: `Medicamento: ${term}`,
              principioActivo: fdaData.active_ingredient[0] || 'N/D',
              dosis: fdaData.dosage_and_administration[0] || 'N/D',
              efectosSecundarios: fdaData.adverse_reactions[0] || 'N/D',
              contraindicaciones: fdaData.contraindications[0] || 'N/D',
              fuente: 'OpenFDA'
            });
          }
        }

        if(activeTab === 'enfermedades') {
          const wikiData = await window.buscarWiki(term, 'es');
          if(wikiData) {
            items.push({
              nombre: wikiData.title,
              descripcion: wikiData.extract,
              sintomas: 'Ver información completa',
              prevencion: 'Consultar fuentes médicas',
              tratamiento: 'Consultar con profesional',
              fuente: 'Wikipedia'
            });
          }
        }

        renderTab(activeTab, items);
      }

      async function loadTabData(tabName) {
        content.innerHTML = '<p>Cargando...</p>';
        
        // Mock loading with sample data
        let items = [];
        if (tabName === 'enfermedades') {
          items = [
            {
              id: '1',
              nombre: 'Hipertensión',
              descripcion: 'Presión arterial alta',
              sintomas: 'Dolor de cabeza, mareos',
              prevencion: 'Dieta saludable, ejercicio',
              tratamiento: 'Medicamentos antihipertensivos'
            }
          ];
        } else if (tabName === 'medicamentos') {
          items = [
            {
              id: '1',
              nombre: 'Ibuprofeno',
              principioActivo: 'Ibuprofeno',
              dosis: '400mg cada 8 horas',
              efectosSecundarios: 'Malestar estomacal',
              contraindicaciones: 'Úlceras gástricas'
            }
          ];
        }
        
        renderTab(tabName, items);
      }

      function renderTab(tabName, items) {
        if(items.length === 0){
          content.innerHTML = '<p>No hay información disponible.</p>';
          return;
        }
        
        const html = items.map(item => {
          const sourceTag = item.fuente ? `<span class="source-tag">${item.fuente}</span>` : '';
          const hasId = item.id && !item.fuente;
          
          if(tabName === 'enfermedades'){
            return `<div class="edu-card">
              <div class="card-header">
                <h3>${item.nombre}</h3>
                ${sourceTag}
              </div>
              <p><strong>Descripción:</strong> ${item.descripcion || 'N/D'}</p>
              <p><strong>Síntomas:</strong> ${item.sintomas || 'N/D'}</p>
              <p><strong>Prevención:</strong> ${item.prevencion || 'N/D'}</p>
              <p><strong>Tratamiento:</strong> ${item.tratamiento || 'N/D'}</p>
              <div class="edu-actions">
                ${hasId ? `
                  <button onclick="window.eduVerDetalle('${tabName}','${item.id}')">Ver más</button>
                  <button onclick="window.eduEditar('${tabName}','${item.id}')">Editar</button>
                  <button onclick="window.eduEliminar('${tabName}','${item.id}')">Eliminar</button>
                ` : `
                  <button onclick="window.eduGuardarExterno('${tabName}', ${JSON.stringify(item).replace(/"/g, '&quot;')})">Guardar localmente</button>
                `}
              </div>
            </div>`;
          }
          
          if(tabName === 'medicamentos'){
            return `<div class="edu-card">
              <div class="card-header">
                <h3>${item.nombre}</h3>
                ${sourceTag}
              </div>
              <p><strong>Principio activo:</strong> ${item.principioActivo || 'N/D'}</p>
              <p><strong>Dosis:</strong> ${item.dosis || 'N/D'}</p>
              <p><strong>Efectos secundarios:</strong> ${item.efectosSecundarios || 'N/D'}</p>
              <p><strong>Contraindicaciones:</strong> ${item.contraindicaciones || 'N/D'}</p>
              <div class="edu-actions">
                ${hasId ? `
                  <button onclick="window.eduVerDetalle('${tabName}','${item.id}')">Ver más</button>
                  <button onclick="window.eduEditar('${tabName}','${item.id}')">Editar</button>
                  <button onclick="window.eduEliminar('${tabName}','${item.id}')">Eliminar</button>
                ` : `
                  <button onclick="window.eduGuardarExterno('${tabName}', ${JSON.stringify(item).replace(/"/g, '&quot;')})">Guardar localmente</button>
                `}
              </div>
            </div>`;
          }
          
          return `<div class="edu-card"><h3>${item.nombre || 'Item'}</h3></div>`;
        }).join('');
        
        content.innerHTML = html;
      }

      function showFormModal(tabName, item) {
        let fields = [];
        if(tabName === 'enfermedades') {
          fields = [
            {name:"nombre",label:"Nombre",type:"text"},
            {name:"descripcion",label:"Descripción",type:"textarea"},
            {name:"sintomas",label:"Síntomas",type:"textarea"},
            {name:"prevencion",label:"Prevención",type:"textarea"},
            {name:"tratamiento",label:"Tratamiento",type:"textarea"}
          ];
        } else if(tabName === 'medicamentos') {
          fields = [
            {name:"nombre",label:"Nombre",type:"text"},
            {name:"principioActivo",label:"Principio Activo",type:"text"},
            {name:"dosis",label:"Dosis",type:"text"},
            {name:"efectosSecundarios",label:"Efectos Secundarios",type:"textarea"},
            {name:"contraindicaciones",label:"Contraindicaciones",type:"textarea"}
          ];
        }

        let html = `<form id="edu-form">${fields.map(f=>`<label>${f.label}</label>${f.type==='textarea'?`<textarea name="${f.name}">${item?.[f.name]||''}</textarea>`:`<input type="${f.type}" name="${f.name}" value="${item?.[f.name]||''}"/>`}`).join('')}<button type="submit">${item?'Guardar cambios':'Agregar'}</button></form>`;
        modalContent.innerHTML = html;
        modal.style.display = 'flex';
        
        document.getElementById('edu-form').onsubmit = function(e) {
          e.preventDefault();
          showToast(item ? 'Elemento actualizado' : 'Elemento agregado');
          modal.style.display = 'none';
          loadTabData(tabName);
        };
      }

      function showYouTubeModal() {
        ytModalContent.innerHTML = `
          <h3>Búsqueda de videos YouTube</h3>
          <div>
            <input type="text" id="youtube_query" placeholder="término de búsqueda" style="width:70%;"/>
            <button id="youtube_buscar">Buscar</button>
          </div>
          <div id="youtube_results"></div>
        `;
        ytModal.style.display = 'flex';
        
        document.getElementById('youtube_buscar').onclick = () => {
          const q = document.getElementById('youtube_query').value.trim();
          if(!q) return;
          
          document.getElementById('youtube_results').innerHTML = `
            <div style="margin:1em 0;padding:1em;border:1px solid #eee;border-radius:5px;">
              <h4>Tutorial: ${q} (Demo)</h4>
              <a href="https://www.youtube.com/results?search_query=${encodeURIComponent(q)}" target="_blank">Ver resultados en YouTube</a>
              <button onclick="window.eduGuardarVideoYT('Tutorial: ${q}','https://www.youtube.com/results?search_query=${encodeURIComponent(q)}')">Agregar al panel</button>
            </div>
          `;
        };
      }

      // Global functions for buttons
      window.eduVerDetalle = function(tabName, id) {
        showToast(`Ver detalle de ${tabName} ${id}`);
      };

      window.eduEditar = function(tabName, id) {
        showFormModal(tabName, {id, nombre: 'Elemento a editar'});
      };

      window.eduEliminar = function(tabName, id) {
        if(confirm("¿Seguro que deseas eliminar este elemento?")) {
          showToast('Elemento eliminado');
          loadTabData(tabName);
        }
      };

      window.eduGuardarExterno = function(tabName, itemData) {
        showToast('Información guardada localmente');
        loadTabData(tabName);
      };

      window.eduGuardarVideoYT = function(titulo, url) {
        showToast('Video agregado');
        ytModal.style.display = 'none';
      };
    }

    // Initialize the education panel
    document.addEventListener('DOMContentLoaded', () => {
      const container = document.getElementById('main-content');
      renderEducacion(container);
    });
  </script>
</body>
</html>